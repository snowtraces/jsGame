<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="js/utils.js"></script>
    <script src="js/bricks.js"></script>
    <title>Tetris</title>
    <style>
        canvas {
            border: 1px solid #666;
        }
    </style>
</head>

<body>
    <canvas id="id-canvas" width="300" height="400"></canvas>
    <script>
        var log = console.log.bind(console)
        var Game = function () {
            var o = {
                keydowns: {},
                actions: {},
                remain: [],
                color: getColor(),
            }
            var canvas = document.querySelector("canvas")
            var context = canvas.getContext("2d")
            context.fillStyle = o.color
            o.canvas = canvas
            o.context = context

            // 绘制砖块
            o.drawBrick = function (brick) {
                var b = brick
                var cells = brick.cells
                for (var i = 0; i < cells.length; i++) {
                    var e = cells[i]
                    context.fillRect(b.x + e[0] * b.w - b.b, b.y + e[1] * b.h - b.b, b.w - 2 * b.b, b.h - 2 * b.b)
                }
            }

            // 绘制保留图案
            o.drawRemain = function (b) {
                var r = o.remain
                for (var i = 0; i < r.length; i++) {
                    var e = r[i]
                    var _color = o.color
                    context.fillStyle = "grey"
                    context.fillRect(e[0] - b.b, e[1] - b.b, b.w - 2 * b.b, b.h - 2 * b.b)
                    context.fillStyle = _color
                }
            }

            o.resetColor = function(){
                o.color = getColor()
                o.context.fillStyle = o.color
            }

            window.addEventListener("keydown", function (event) {
                o.keydowns[event.key] = true
                // o.actions[event.key]()
            })
            window.addEventListener("keyup", function (event) {
                o.keydowns[event.key] = false
            })

            // 注册事件
            o.registerAction = function (key, callback) {
                o.actions[key] = callback
            }
            o.checkTouch = function (brick) {
                if (brick.begin && checkTouchRemain(brick, o.remain)) {
                    log("碰撞")
                    var realCells = brick.getRealXYCells()
                    o.remain = o.remain.concat(realCells)
                    return true
                }
                return false
            }

            // 执行游戏
            o.run = function () {
                var actions = Object.keys(o.actions)
                for (var i = 0; i < actions.length; i++) {
                    var key = actions[i]
                    if (o.keydowns[key]) {
                        o.actions[key]()
                    }
                }
                brick.moveDown()
            }

            return o
        }

        var Brick = function () {
            var o = {
                w: 10,
                h: 10,
                x: 20,
                y: 20,
                step: 10,
                speed: 10,
                b: 1,
                cells: getBrick(),
                begin: false,
            }

            // 旋转 brick
            o.rotate = function () {
                if (!o.begin) return
                log("旋转")
                var _cells = []
                for (var i = 0; i < o.cells.length; i++) {
                    var e = o.cells[i]
                    var _cell = [
                        -e[1],
                        e[0],
                    ]
                    _cells.push(_cell)
                }
                o.cells = _cells
            }

            o.getRealXYCells = function () {
                var realCells = []
                for (var i = 0; i < o.cells.length; i++) {
                    var cell = o.cells[i];
                    // 计算真实左上角坐标
                    cellX = o.x + cell[0] * o.w
                    cellY = o.y + cell[1] * o.h
                    var _cell = [cellX, cellY]
                    realCells.push(_cell)
                }
                return realCells
            }

            var moveInRange = function (canvasW) {
                var minX = 0
                var maxX = canvasW - o.w
                var realCells = o.getRealXYCells()

                // 计算block边缘
                var _minX = 0
                var _maxX = 0
                for (var i = 0; i < realCells.length; i++) {
                    var cell = realCells[i];
                    var _x = cell[0]
                    if (i == 0) {
                        _minX = _x
                        _maxX = _x
                    } else {
                        _minX = _x < _minX ? _x : _minX
                        _maxX = _x > _maxX ? _x : _maxX
                    }
                }

                // 判断是否超出边缘
                if (_minX < minX) {
                    console.log("左：", o.x)
                    return o.x + o.step
                } else if (_maxX > maxX) {
                    return o.x - o.step
                }
                return o.x
            }

            // move
            o.moveLeft = function (canvasW) {
                if (!o.begin) return
                o.x -= o.step
                o.x = moveInRange(canvasW)
            }
            o.moveRight = function (canvasW) {
                if (!o.begin) return
                o.x += o.step
                o.x = moveInRange(canvasW)
            }
            o.moveDown = function () {
                if (!o.begin) return
                o.y += o.speed
            }

            // 开始游戏
            o.go = function () {
                log("go")
                o.begin = !o.begin
            }
            return o
        }

        var brick = Brick()
        var game = Game()
        var canvasW = 300
        var canvasH = 400

        game.drawBrick(brick)
        game.registerAction("w", function () {
            brick.rotate()
        })
        game.registerAction("a", function () {
            brick.moveLeft(canvasW)
        })
        game.registerAction("d", function () {
            brick.moveRight(canvasW)
        })
        game.registerAction("g", function () {
            brick.go()
        })

        setInterval(function () {
            game.run(brick)
            game.context.clearRect(0, 0, game.canvas.width, game.canvas.height)
            var isTouch = game.checkTouch(brick)
            if (isTouch) {
                game.resetColor()
                brick = Brick()
                brick.begin = true
            }
            game.drawBrick(brick)
            game.drawRemain(brick)
        }, 1000 / 8 + 1)

    </script>

</body>

</html>