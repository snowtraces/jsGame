<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Tetris</title>
    <style>
        canvas {
            border: 1px solid #666;
        }
    </style>
</head>

<body>
    <canvas id="id-canvas" width="300" height="400"></canvas>
    <script>
        var log = console.log.bind(console)
        var Game = function () {
            var o = {
                keydowns: {},
                actions: {},
            }
            var canvas = document.querySelector("canvas")
            var context = canvas.getContext("2d")
            context.fillStyle = "grey"
            o.canvas = canvas
            o.context = context

            // 绘制砖块
            o.drawBrick = function (brick) {
                var cells = brick.cells
                for (var i = 0; i < cells.length; i++) {
                    var e = cells[i]
                    context.fillRect(brick.x + e[0] * 10, brick.y + e[1] * 10, brick.w, brick.h)
                }
            }

            window.addEventListener("keydown", function (event) {
                o.keydowns[event.key] = true
                // o.actions[event.key]()
            })
            window.addEventListener("keyup", function (event) {
                o.keydowns[event.key] = false
            })

            // 注册事件
            o.registerAction = function (key, callback) {
                o.actions[key] = callback
            }

            // 执行游戏
            o.run = function () {
                var actions = Object.keys(o.actions)
                for (var i = 0; i < actions.length; i++) {
                    var key = actions[i]
                    if (o.keydowns[key]) {
                        o.actions[key]()
                    }
                }
                brick.moveDown()
            }


            return o
        }

        var Brick = function () {
            var bricks = [
                [
                    [0, 0],
                    [-1, 0],
                    [1, 0],
                    [0, 1],
                ],
            ]
            var o = {
                w: 10,
                h: 10,
                x: 20,
                y: 20,
                step: 10,
                speed: 10,
                cells: bricks[0],
                begin: false,
            }

            // 旋转 brick
            o.rotate = function () {
                if (!o.begin) return
                log("旋转")
                var _cells = []
                for (var i = 0; i < o.cells.length; i++) {
                    var e = o.cells[i]
                    var _cell = [
                        -e[1],
                        e[0],
                    ]
                    _cells.push(_cell)
                }
                o.cells = _cells
            }

            // 计算边缘
            var calcEdge = function () {
                var left, right, bottom
                for (var i = 0; i < o.brick.length; i++) {
                    var e = o.brick[i];
                    if (i == 0) {
                        left = e[0]
                        right = e[0]
                        bottom = e[1]
                    } else {
                        left = e[0] < left ? e[0] : left
                        right = e[0] > right ? e[0] : right
                        bottom = e[1] > bottom ? e[1] : bottom
                    }
                }
                o.left = left
                o.right = right
                o.bottom = bottom
            }

            // 计算边缘碰撞边框
            o.checkTouchEdge = function(){
                
            }

            // move
            o.moveLeft = function () {
                if (!o.begin) return
                o.x -= o.step
            }
            o.moveRight = function () {
                if (!o.begin) return
                o.x += o.step
            }
            o.moveDown = function () {
                if (!o.begin) return
                o.y += o.speed
            }

            // 开始游戏
            o.go = function () {
                log("go")
                o.begin = true
            }
            return o
        }


        var brick = Brick()
        var game = Game()
        var firm = []

        game.drawBrick(brick)
        game.registerAction("w", function () {
            brick.rotate()
        })
        game.registerAction("a", function () {
            brick.moveLeft()
        })
        game.registerAction("d", function () {
            brick.moveRight()
        })
        game.registerAction("g", function () {
            brick.go()
        })

        setInterval(function () {
            game.run(brick)
            game.context.clearRect(0, 0, game.canvas.width, game.canvas.height)
            game.drawBrick(brick)
        }, 1000 / 8 + 1)

    </script>

</body>

</html>